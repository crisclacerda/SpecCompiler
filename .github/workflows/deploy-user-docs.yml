name: Deploy User Documentation

on:
  push:
    tags: ['user-docs*']

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-user-docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Lowercase image name
        run: echo "IMAGE_NAME=${IMAGE_NAME,,}" >> $GITHUB_ENV

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build user documentation
        run: |
          docker run --rm \
            --user "$(id -u):$(id -g)" \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            "${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" \
            /opt/speccompiler/bin/speccompiler-core docs/user_docs/project.yaml

      - name: Deploy to GitHub Pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch gh-pages branch or create it
          if git fetch origin gh-pages; then
            git worktree add _gh-pages origin/gh-pages
          else
            git worktree add --orphan _gh-pages
            cd _gh-pages && git checkout --orphan gh-pages && cd ..
          fi

          # Update only the manual subdirectory
          rm -rf _gh-pages/manual
          mkdir -p _gh-pages/manual
          cp docs/user_docs/build/www/* _gh-pages/manual/
          mkdir -p _gh-pages/manual/downloads
          cp docs/user_docs/build/docx/*.docx _gh-pages/manual/downloads/

          # Commit and push
          cd _gh-pages
          git add -A
          git diff --cached --quiet && echo "No changes to deploy" && exit 0
          git commit -m "Deploy user documentation from ${GITHUB_REF_NAME}"
          git push origin HEAD:gh-pages
